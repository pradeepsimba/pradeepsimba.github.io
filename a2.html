<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="12.png" type="image/icon type">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2 Configurations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
    <div class="card shadow p-4">
        <h2 class="text-center mb-4">A2 Configurations</h2>
        
        <div class="mb-3">
            <label for="port1" class="form-label">Enter website Port:</label>
            <input type="number" id="port1" class="form-control" value="8101">
        </div>
        
        <div class="mb-3">
            <label for="port2" class="form-label">Enter gunicorn Port:</label>
            <input type="number" id="port2" class="form-control" value="81">
        </div>
        
        <div class="mb-3">
            <label for="djangoContainer" class="form-label">Enter Django Container Name:</label>
            <input type="text" id="djangoContainer" class="form-control" value="sample" oninput="validateInput(this)" />

            <script>
              function validateInput(input) {
                // Remove any character that is not an alphabet or an underscore
                input.value = input.value.replace(/[^a-z_]/g, '');
              }
            </script>
            
        </div>
        
        <button class="btn btn-primary w-100 mb-3" onclick="generateConfig()">Generate Config</button>
        <br>    
        <button id="downloadBtn" class="btn btn-success w-100 mb-3" onclick="downloadFiles()" style="display: none;">Download All Files</button>

        <h3 class="mt-4">default.conf</h3>
        <textarea id="configOutput" class="form-control" rows="6" readonly></textarea>
        
        <h3 class="mt-4">docker-compose.yml</h3>
        <textarea id="composeOutput" class="form-control" rows="6" readonly></textarea>
        
        <h3 class="mt-4">Dockerfile</h3>
        <textarea id="dockerfileOutput" class="form-control" rows="6" readonly></textarea>
        
        <h3 class="mt-4">Enter in Django Settings:</h3>
        <textarea id="djangoSettings" class="form-control" rows="6" readonly></textarea>
        
        <h3 class="mt-4">remove-old.sh</h3>
        <textarea id="remove_old_containers" class="form-control" rows="3" readonly></textarea>
        
        <h3 class="mt-4">log.sh</h3>
        <textarea id="docker_logs" class="form-control" rows="3" readonly></textarea>

        <h3 class="mt-4">deploy.sh</h3>
        <textarea id="deploy_script" class="form-control" rows="3" readonly></textarea>

        <h3 class="mt-4">browsefiles.sh</h3>
        <textarea id="browsefiles" class="form-control" rows="3" readonly></textarea>
        
    </div>

    <script>
        function generateConfig() {
            const port1 = document.getElementById('port1').value;
            const port2 = document.getElementById('port2').value;
            const djangoContainer = document.getElementById('djangoContainer').value;
            const nginxContainer = djangoContainer + "_nginx";  // Append "_nginx" to the Django container name
            
                // Deploy Script
            const deployScript = `sudo apt update && sudo apt upgrade && sudo snap refresh && git pull && docker-compose -p ${djangoContainer} up -d --build`;
            const lastTwoDigits = parseInt(port1.slice(-2), 10) + 433;
            console.log(lastTwoDigits);
        // Set the output values
           document.getElementById('deploy_script').value = deployScript;

            // Nginx Configuration
            const nginxConfig = `server {
    listen ${port1} ssl;
    server_name ${djangoContainer}.a2.mpulse.plus;

    ssl_certificate /etc/nginx/ssl/a2.mpulse.plus.crt;
    ssl_certificate_key /etc/nginx/ssl/a2_mpulse_plus_private.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256";
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    client_max_body_size 500M;

    location / {
        proxy_pass http://${djangoContainer}django_app:${port2};
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }

    location /static/ {
        alias /app/static/;
    }
}`;

            // Docker Compose Configuration
            const composeConfig = `services:
  ${djangoContainer}django_app:
    container_name: ${djangoContainer}
    build: .
    expose:
      - "${port2}"
    environment:
      - DJANGO_ALLOWED_HOSTS=a2.mpulse.plus
    volumes:
      - .:/app
      - static_volume:/app/static
      - /home/ubuntu/dotenv/a2/.env:/app/amazon/.env  # Bind mount the .env file
    extra_hosts:
      - "host.docker.internal:host-gateway"  # ðŸ‘ˆ Important for accessing host DB
    restart: always

  ${nginxContainer}:
    container_name: ${nginxContainer}
    image: nginx:latest
    ports:
      - "${port1}:${port1}"
      - "${lastTwoDigits}:443"
    volumes:
      - ./default.conf:/etc/nginx/conf.d/default.conf
      - static_volume:/app/static
      - ./certs:/etc/nginx/ssl  
    depends_on:
      - ${djangoContainer}django_app
    restart: always

volumes:
  static_volume:`;

            // Dockerfile
            const dockerfileConfig = `
FROM ghcr.io/pradeep-mahima-tech/a2-env:latest

# Set the working directory in the container
WORKDIR /app

# Copy the project files into the container
COPY . /app/

RUN python manage.py collectstatic --noinput

# Expose port for Gunicorn
EXPOSE ${port2}

# Start the Django application with Gunicorn
CMD ["gunicorn", "--bind", "0.0.0.0:${port2}", "amazon.wsgi:application"]`;

            // Django Settings Configuration
            const djangoSettings = `
ALLOWED_HOSTS = ['a2.mpulse.plus', 'localhost']

CSRF_TRUSTED_ORIGINS = ['https://a2.mpulse.plus:${port1}']
CSRF_COOKIE_SECURE = True
SESSION_COOKIE_SECURE = True
CSRF_USE_SESSIONS = True

DATA_UPLOAD_MAX_MEMORY_SIZE = 1000 * 1024 * 1024
FILE_UPLOAD_MAX_MEMORY_SIZE = 1000 * 1024 * 1024
#  'HOST': 'host.docker.internal'`;

            const browserfiles = `docker exec -it ${djangoContainer} bash`

            // Remove old containers command
            const removeOldContainers = `docker stop ${djangoContainer} ${nginxContainer} && docker rm ${djangoContainer} ${nginxContainer} && docker container prune -f && docker system prune -a -f && docker-compose -p ${djangoContainer} down -v`;

            // Follow Docker logs command
            const dockerLogsCommand = `docker logs -f ${djangoContainer}`;

            // Set the output values
            document.getElementById('configOutput').value = nginxConfig;
            document.getElementById('composeOutput').value = composeConfig;
            document.getElementById('dockerfileOutput').value = dockerfileConfig;
            document.getElementById('djangoSettings').value = djangoSettings;
            document.getElementById('remove_old_containers').value = removeOldContainers;
            document.getElementById('docker_logs').value = dockerLogsCommand;
            document.getElementById('browsefiles').value = browserfiles;
            document.getElementById('downloadBtn').style.display = "block";
        }
    </script>

    <script>
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    
        async function downloadFiles() {
            generateConfig(); // Ensure the latest data is generated

            try {
                // Open a directory picker for the user to select a folder
                const dirHandle = await window.showDirectoryPicker();

                // Function to create and write a file in the chosen directory
                async function writeFile(dirHandle, filePath, content) {
                    const pathParts = filePath.split("/"); // Split path into folders and filename
                    let currentDir = dirHandle;

                    // Traverse and create subdirectories if needed
                    for (let i = 0; i < pathParts.length - 1; i++) {
                        currentDir = await currentDir.getDirectoryHandle(pathParts[i], { create: true });
                    }

                    // Create the file inside the correct folder
                    const fileHandle = await currentDir.getFileHandle(pathParts[pathParts.length - 1], { create: true });
                    const writable = await fileHandle.createWritable();
                    
                    // Ensure content is a valid string
                    if (typeof content !== "string") {
                        content = String(content); // Convert to string if needed
                    }

                    await writable.write(content);
                    await writable.close();
                }


                const certfile = `-----BEGIN CERTIFICATE-----
MIIGdzCCBN+gAwIBAgIRAKNStysGnpf2gJtRAIgw4mQwDQYJKoZIhvcNAQELBQAw
YDELMAkGA1UEBhMCR0IxGDAWBgNVBAoTD1NlY3RpZ28gTGltaXRlZDE3MDUGA1UE
AxMuU2VjdGlnbyBQdWJsaWMgU2VydmVyIEF1dGhlbnRpY2F0aW9uIENBIERWIFIz
NjAeFw0yNTA5MTUwMDAwMDBaFw0yNjA5MTUyMzU5NTlaMBkxFzAVBgNVBAMTDmEy
Lm1wdWxzZS5wbHVzMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoFg4
vDK6w3eqPYNUtSPNty9gpEGAC5myNn84HNvUgmfE1TxAiDAbgsphuTc6XEN2Enoa
vbMkH3gv/8XCJ7MMbuFJjzRYvtBc78UMW++/N/3ABpCgKKeyjia8OtprgtmBe8SO
I/33c+BTcwSXrN+PPpfm2NOEtjP6aPBx/tNlGPi+2/EMte4bnar61MFOR1GJC8EF
WiJj0FfGSYx92RflQWeC/80gU+5V6koCKzqnG18AFFVfZQN5hR0cXNRvnv4aVx15
KphwS4xPxfNjXjY88snD8RDjXD94ri3GhU3pqlWhq7CPyA8sO9UO4xOlkvhFjMzm
IEPn/NY2AIHq7LelwwIDAQABo4IC8TCCAu0wHwYDVR0jBBgwFoAUaMASFhgOr872
h6YyV6NGUV3LBycwHQYDVR0OBBYEFMLgkM3zG22iAprzK+Ma736tbhT0MA4GA1Ud
DwEB/wQEAwIFoDAMBgNVHRMBAf8EAjAAMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggr
BgEFBQcDAjBJBgNVHSAEQjBAMDQGCysGAQQBsjEBAgIHMCUwIwYIKwYBBQUHAgEW
F2h0dHBzOi8vc2VjdGlnby5jb20vQ1BTMAgGBmeBDAECATCBhAYIKwYBBQUHAQEE
eDB2ME8GCCsGAQUFBzAChkNodHRwOi8vY3J0LnNlY3RpZ28uY29tL1NlY3RpZ29Q
dWJsaWNTZXJ2ZXJBdXRoZW50aWNhdGlvbkNBRFZSMzYuY3J0MCMGCCsGAQUFBzAB
hhdodHRwOi8vb2NzcC5zZWN0aWdvLmNvbTCCAX8GCisGAQQB1nkCBAIEggFvBIIB
awFpAHcA2AlVO5RPev/IFhlvlE+Fq7D4/F6HVSYPFdEucrtFSxQAAAGZS8kxXAAA
BAMASDBGAiEA6fbZJ+NKWiqfnzBQBtBi2EbgXsVL+SkTAxWiuqIVR5oCIQCGqkhf
Qc+H3Bi7U4BVou05RUXBOC2WryaZDgE+GCZ+yQB2AK9niDtXsE7dj6bZfvYuqOuB
CsdxYPAkXlXWDC/nhYc6AAABmUvJMcgAAAQDAEcwRQIgU8Gtd76jQ0k/6J+pDGRk
1NJDcXPoqXSyAaQjruG7I6ACIQCEKJVmrbkmbEK5rFUIQy80g8j0qafsmX3cObzs
Dp1jkgB2ANdtfRDRp/V3wsfpX9cAv/mCyTNaZeHQswFzF8DIxWl3AAABmUvJMPUA
AAQDAEcwRQIgEO9EP2BYi3Jw3XAs7JgtUJ6KiH5HLijX8K2dtDEA/CECIQCxeu0t
jK6+9AU6IHMRBNwymnrE02MGbVCPH2d1VQrlYjAZBgNVHREEEjAQgg5hMi5tcHVs
c2UucGx1czANBgkqhkiG9w0BAQsFAAOCAYEAE3fDImICnQDN3Je5rdhOo0rVxmXK
oW9Vywgn37gHJVWxJ//hubPx4hvHn5gYaQ+a42wpPjVvUFq+qle4N8rZl9A9Tmrg
14xaCqU/zWY5YjvJmWuqTYIHy4VA7BLV9fhd98jrDXmvo2WWcDT1DkX6nppG9YMm
TylOUGYDuyoC72DrRNKfiKe74SHGSliC9rXSrPK/+hjv610ul0p7sOtE/WsC9aw0
Ka4BgWPXxZBeHChkFLPWuZV5hW3dKRkTIdLiHjpgd5iQ2T0l4RnIab1g5Vgku8S2
7HA8yoXPadI2OmH6Wxjv3Kh6yKXMFHLauxU3x7aDyughHX+aHP+QlGTU2ZWHJdez
EW1X+u0g7Ykles9qwoglkJyW5RkSX199vPvv+kEkc5EVF/zKHHGpeuHLZfhTsR3H
ovvew3cxyM9E8pXlc1FtzI/YWH6OaOu/rJyDOk/rlx8g3DzT5oaq0ZSoLLAFOwTb
yPvF6tx9UyPFBQCsb+mNjhw4ODlSh9tlA+VR
-----END CERTIFICATE-----`;

                const privatekey = `-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCgWDi8MrrDd6o9
g1S1I823L2CkQYALmbI2fzgc29SCZ8TVPECIMBuCymG5NzpcQ3YSehq9syQfeC//
xcInswxu4UmPNFi+0FzvxQxb7783/cAGkKAop7KOJrw62muC2YF7xI4j/fdz4FNz
BJes348+l+bY04S2M/po8HH+02UY+L7b8Qy17hudqvrUwU5HUYkLwQVaImPQV8ZJ
jH3ZF+VBZ4L/zSBT7lXqSgIrOqcbXwAUVV9lA3mFHRxc1G+e/hpXHXkqmHBLjE/F
82NeNjzyycPxEONcP3iuLcaFTemqVaGrsI/IDyw71Q7jE6WS+EWMzOYgQ+f81jYA
gerst6XDAgMBAAECggEAAlbHHRewWcGZHiSYS7wl+BIc2siJ0aGAVAMvElyykORq
nqGuX040WIgTPNxtYYMqacKWOUYvtLXQHW8JEgMunz9yD0C4OrBXarf5Ii4xH+P3
tSDO9Ujc9e3iuQkOoG4D0YZgfG3r+ii/juH2RHNOZ59XoroTKYVAld9MCmeTBfY1
BV1igMMPZk1eyi43zsy57pnqaF35Zr1fyBaj3Gnj8JT6sK/4ywsiqrr0kCAp8NN2
cGG2SH/Ln2hgXetIOGLQBK76sUHfd2OtGgICYtdr3RE66kmUIjiFMWtt7UC4qsB7
gtmYEkTgh5llwRID2NP97LomyANxxgo4PmRvg1q9IQKBgQDZ0yyYx8h6wNDsLLgN
0MDQ2issjFVDfdepgxAEneAKQXufeDsqhCzh0942ukdZqEKoIJ8ueWrZHrcoP8wj
esZ7nbjHlEcN7MIAuTiBfz9lLacaQE7zTwYIvW9wRofxubEoWIxh5cbczrfSSBcp
dEsAw+nWbqK0AxxQykb6kTg6dwKBgQC8cio+3ruLE0Xy7WPD8If0W2Zyb3CJGg73
9xwV3qHNe+0norTpOL7aapsdF9oc+9bqvQsq+PbadFK7zMqrj5bXoQaZ9X8/wZBW
GMAh6TEH1w0+tOjr0iMZuwU024Uvx6G5xXTNhNcXmZXpd7NnAcyqWXgUeEOJRLT/
04Efixh2FQKBgF8k4Gvzh9wmcJtYhSRztGUFhqo0ueF7DEJcnxiFJSEVrTvgtmdB
yKDzfDKHdzbwSf1KEn2oR0WDJxmLlE1DCYNhRx7V45tveOX8AXR+8l/tavoKcPHR
6J7Ur+JozGSHaZxn4Rm51f0Ixj4xgvx2cXRqHq+tL6BVY37ee9ZirB7NAoGACTCY
FtDN3I5oDty8zMViG+yJJnOAzW7T5AvM9tQQl/C/M/ufTvBRfl1MizKqlFdDt9bY
QJQ7lZOupTHrgEpUVNepdsCeIAHUhB5Y4E568aLvJmu0ICvzQkH4kwdRi2702BZl
B9C+nIwE34nS2ecgj/4k+PqUcJFFMmSiG2OxIbECgYBWnfFJASNdyNNXmtP5l5md
kqPM+KALLEi8t0ipDeatX8G38HKOj//lMFLK9W646SDg4YLgXSN9zEsMQ0Rx4Vy0
u415TPzHE+0EeOGsE/qoQhjk2Fs4EPSeipZma5RfJQydxtNNlkE7V9xs47C95TPG
6Ik2Sq4WmdFce5cctTFYzQ==
-----END PRIVATE KEY-----`;

                // Fetching content from textareas
                const files = [
                    { name: "default.conf", content: document.getElementById("configOutput").value },
                    { name: "docker-compose.yml", content: document.getElementById("composeOutput").value },
                    { name: "Dockerfile", content: document.getElementById("dockerfileOutput").value },
                    // { name: "django_settings.txt", content: document.getElementById("djangoSettings").value },
                    { name: "remove-old.sh", content: document.getElementById("remove_old_containers").value },
                    { name: "log.sh", content: document.getElementById("docker_logs").value },
                    { name: "deploy.sh", content: document.getElementById("deploy_script").value },
                    { name: "browsefiles.sh", content: document.getElementById("browsefiles").value },
                    { name: "certs/a2.mpulse.plus.crt", content: certfile },
                    { name: "certs/a2_mpulse_plus_private.key", content: privatekey }
                ];

              
                // Writing all files in the chosen folder
                for (const file of files) {
                    await writeFile(dirHandle, file.name, file.content);
                }


                        // Show success message using SweetAlert
                        Swal.fire({
                            title: "Download Complete!",
                            text: "All configuration files have been saved successfully.",
                            icon: "success",
                            confirmButtonText: "OK"
                        });
            } catch (error) {
                console.error("File saving failed:", error);
                Swal.fire({
                    title: "Download Failed!",
                    text: "Ensure you're using a supported browser and try again.",
                    icon: "error",
                    confirmButtonText: "Retry"
                });
            }
        }

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert Library -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
