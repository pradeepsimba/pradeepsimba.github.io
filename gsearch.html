<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="12.png" type="image/icon type">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pradeep Simba</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Theme - Neumorphism */
            --bg-light: #e0e5ec;
            --text-light: #5b6673;
            --primary-light: #17c03c;
            --shadow-light-1: #a3b1c6;
            --shadow-light-2: #ffffff;
            --neumorphic-shadow-light: 6px 6px 12px var(--shadow-light-1), -6px -6px 12px var(--shadow-light-2);
            --neumorphic-shadow-inset-light: inset 6px 6px 12px var(--shadow-light-1), inset -6px -6px 12px var(--shadow-light-2);
            --border-light: #d1d9e6;

            /* Dark Theme - Neumorphism */
            --bg-dark: #2c2c2c;
            --text-dark: #b0b0b0;
            --primary-dark: #ff4b5c;
            --shadow-dark-1: #1e1e1e;
            --shadow-dark-2: #3a3a3a;
            --neumorphic-shadow-dark: 6px 6px 12px var(--shadow-dark-1), -6px -6px 12px var(--shadow-dark-2);
            --neumorphic-shadow-inset-dark: inset 6px 6px 12px var(--shadow-dark-1), inset -6px -6px 12px var(--shadow-dark-2);
            --border-dark: #3a3a3a;
            
            /* Default to light theme variables */
            --primary: var(--primary-light);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            padding-top: 100px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        /* --- Components --- */
        .navbar, .card, .modal-content {
            border-radius: 20px;
            background-color: var(--bg-light);
            box-shadow: var(--neumorphic-shadow-light);
            border: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .dark-mode .navbar, .dark-mode .card, .dark-mode .modal-content {
            background-color: var(--bg-dark);
            box-shadow: var(--neumorphic-shadow-dark);
        }

        .navbar {
            padding: 1rem 1.5rem;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--primary) !important;
        }
        
        .dark-mode .navbar-brand {
             color: var(--primary-dark) !important;
        }

        /* BUG FIX: Toggler icon color in dark mode */
        .navbar-toggler {
            border: none;
        }
        .navbar-toggler:focus {
            box-shadow: none;
        }
        .dark-mode .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.8)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }


        /* --- Inputs and Buttons --- */
        .form-control, .btn {
            border-radius: 30px;
            border: none;
            background-color: var(--bg-light);
            box-shadow: var(--neumorphic-shadow-inset-light);
            transition: box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .dark-mode .form-control, .dark-mode .btn {
            background-color: var(--bg-dark);
            box-shadow: var(--neumorphic-shadow-inset-dark);
            color: var(--text-dark);
        }

        .form-control {
            padding: 0.5rem 1rem;
        }
        .form-control::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }
        .dark-mode .form-control::placeholder {
            color: var(--text-dark);
        }
        
        .btn {
            box-shadow: var(--neumorphic-shadow-light);
            color: var(--text-light);
            font-weight: 600;
        }
        .btn:active, .btn:focus {
            box-shadow: var(--neumorphic-shadow-inset-light) !important;
        }
        .dark-mode .btn:active, .dark-mode .btn:focus {
            box-shadow: var(--neumorphic-shadow-inset-dark) !important;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .dark-mode .btn-primary {
            background-color: var(--primary-dark);
        }
        
        .btn-outline-secondary { /* Re-style this for Neumorphism */
            background-color: transparent;
        }
        .dark-mode .btn-outline-secondary {
            color: var(--text-dark);
        }
        
        /* --- Card Specifics --- */
        #app {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 2rem;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            font-weight: 600;
            color: var(--text-light);
        }
        .dark-mode .card-title {
             color: #e0e0e0;
        }
        .card hr {
            border-color: var(--border-light);
        }
        .dark-mode .card hr {
            border-color: var(--border-dark);
        }
        .card-actions .btn {
            background-color: transparent;
            box-shadow: none;
            color: var(--text-light);
            opacity: 0.7;
        }
        .dark-mode .card-actions .btn {
            color: var(--text-dark);
        }
        .card-actions .btn:hover {
            opacity: 1;
            color: var(--primary);
        }
        .dark-mode .card-actions .btn:hover {
            color: var(--primary-dark);
        }
        
        /* --- Utilities & Other --- */
        #dark-mode-toggle {
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-light);
        }
        #dark-mode-toggle:hover {
            color: var(--primary);
        }
        .dark-mode #dark-mode-toggle {
            color: var(--text-dark);
        }
        .dark-mode #dark-mode-toggle:hover {
            color: var(--primary-dark);
        }
        #loading-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            grid-column: 1 / -1;
            color: var(--text-light);
        }
        .dark-mode #loading-message {
            color: var(--text-dark);
        }

        /* Modal Theming */
        .dark-mode .modal-header, .dark-mode .modal-footer {
             border-color: var(--border-dark);
        }
        .dark-mode .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
    </style>
</head>

<body onload="loadTheme()">

    <nav class="navbar navbar-expand-lg fixed-top mx-3 mt-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Pradeep Simba</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <form class="d-flex w-100 my-2 my-lg-0 mx-lg-4" id="search-books" role="search">
                    <input class="form-control me-2" type="search" placeholder="Search bookmarks..." name="search" aria-label="Search">
                </form>
                <div class="d-flex align-items-center justify-content-end mt-2 mt-lg-0">
                     <div id="dark-mode-toggle" onclick="toggleTheme()" class="me-4">
                        <i id="theme-icon" class="fas fa-moon"></i>
                    </div>
                    <div class="auth-buttons d-flex gap-2">
                        <button class="btn btn-primary add-book-btn" style="display: none;" onclick="openBookModal('add')">Add Book</button>
                        <button class="btn btn-primary signin-btn">Sign In</button>
                        <button class="btn signout-btn" style="display: none;">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div id="app">
            <div id="loading-message">
                Please sign in to load content from Google Drive.
            </div>
        </div>
    </div>

    <div class="modal fade" id="addOrEditBookModal" tabindex="-1" aria-labelledby="addOrEditBookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-2">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="addOrEditBookModalLabel">Add New Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        <div class="mb-3">
                            <label for="bookTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="bookDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="bookLink" class="form-label">Answer Link</label>
                            <input type="url" class="form-control" id="bookLink" placeholder="https://example.com/answer">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkA" class="form-label">Ref Link 1</label>
                            <input type="url" class="form-control" id="bookRefLinkA" placeholder="https://example.com/ref1">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkB" class="form-label">Ref Link 2</label>
                            <input type="url" class="form-control" id="bookRefLinkB" placeholder="https://example.com/ref2">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkC" class="form-label">Ref Link 3</label>
                            <input type="url" class="form-control" id="bookRefLinkC" placeholder="https://example.com/ref3">
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary py-2">Save Book</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- THEME TOGGLE FUNCTIONS ---
        function toggleTheme() {
            const element = document.body;
            const icon = document.getElementById("theme-icon");
            const isDarkMode = element.classList.contains("dark-mode");
            const theme = isDarkMode ? "light" : "dark";

            element.classList.toggle("dark-mode");
            localStorage.setItem("theme", theme);
            icon.className = theme === "dark" ? "fas fa-sun" : "fas fa-moon";

            const root = document.documentElement;
            if (theme === "dark") {
                root.style.setProperty("--primary", "var(--primary-dark)");
            } else {
                root.style.setProperty("--primary", "var(--primary-light)");
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem("theme") || "light";
            if (theme === "dark") {
                document.body.classList.add("dark-mode");
                document.getElementById("theme-icon").className = "fas fa-sun";
                document.documentElement.style.setProperty("--primary", "var(--primary-dark)");
            } else {
                document.documentElement.style.setProperty("--primary", "var(--primary-light)");
            }
        }

        // --- GOOGLE DRIVE API AND ALL OTHER JS LOGIC (UNCHANGED) ---

        // IMPORTANT: REPLACE THESE WITH YOUR ACTUAL GOOGLE CLOUD PROJECT CREDENTIALS
        const CLIENT_ID = '683702979714-b9p8hkaqrrk2g12nbv3jqkbsf5mlmi59.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyBF-k8OwJlDftANtaR8kiX5KIRym4Zlvp8'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let GOOGLE_DRIVE_JSON_FILE_ID = '';
        const APP_FOLDER_NAME = "Pradeep Simba App Data";
        const JSON_FILE_NAME = "data.json";
        const DEFAULT_JSON_CONTENT = '[]';
        let tokenClient;
        let signinButton, signoutButton, addBookButton, appContainer, loadingMessage;
        let addOrEditBookModal;
        let gapiInited = false;
        let gisInited = false;
        let domLoaded = false;
        let books = [];
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                checkIfAllReady();
            } catch (error) {
                console.error("Error initializing GAPI client:", error);
            }
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleTokenResponse,
            });
            gisInited = true;
            checkIfAllReady();
        }
        
        function checkIfAllReady() {
            if (gapiInited && gisInited && domLoaded) {
                signinButton.style.display = 'block';
                if (gapi.client.getToken()) {
                    handleAuthSuccess();
                }
            }
        }
        
        window.onload = () => {
            signinButton = document.querySelector('.signin-btn');
            signoutButton = document.querySelector('.signout-btn');
            addBookButton = document.querySelector('.add-book-btn');
            appContainer = document.getElementById('app');
            loadingMessage = document.getElementById('loading-message');
            addOrEditBookModal = new bootstrap.Modal(document.getElementById('addOrEditBookModal'));
            if (signinButton) signinButton.onclick = handleAuthClick;
            if (signoutButton) signoutButton.onclick = handleSignoutClick;
            document.getElementById('bookForm').addEventListener('submit', submitBookForm);
            domLoaded = true;
            loadTheme();
            checkIfAllReady();
        };
        
        async function handleTokenResponse(resp) {
            if (resp.error) {
                return;
            }
            gapi.client.setToken(resp);
            handleAuthSuccess();
        }
        
        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    signinButton.style.display = 'block';
                    signoutButton.style.display = 'none';
                    addBookButton.style.display = 'none';
                    appContainer.innerHTML = '<div id="loading-message">Please sign in to load content from Google Drive.</div>';
                    books = [];
                });
            }
        }
        
        async function handleAuthSuccess() {
            signinButton.style.display = 'none';
            signoutButton.style.display = 'block';
            addBookButton.style.display = 'block';
            loadingMessage.innerHTML = 'Checking/Creating Google Drive files...';
            await checkAndCreateJsonFile();
        }
        
        async function checkAndCreateAppDataFolder() {
            let folderId = localStorage.getItem('app_folder_id');
            if (folderId) {
                try {
                    const response = await gapi.client.drive.files.get({ fileId: folderId, fields: 'id, name, mimeType, trashed' });
                    if (response.result && response.result.mimeType === 'application/vnd.google-apps.folder' && !response.result.trashed) {
                        return folderId;
                    } else {
                        localStorage.removeItem('app_folder_id');
                    }
                } catch (error) {
                    localStorage.removeItem('app_folder_id');
                }
            }
            const response = await gapi.client.drive.files.list({ q: `name = '${APP_FOLDER_NAME}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`, fields: 'files(id)' });
            if (response.result.files && response.result.files.length > 0) {
                folderId = response.result.files[0].id;
            } else {
                const folderResponse = await gapi.client.drive.files.create({ resource: { name: APP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' }, fields: 'id' });
                folderId = folderResponse.result.id;
            }
            localStorage.setItem('app_folder_id', folderId);
            return folderId;
        }
        
        async function checkAndCreateJsonFile() {
            try {
                const appFolderId = await checkAndCreateAppDataFolder();
                let fileId = localStorage.getItem('google_drive_json_file_id');
                if (fileId) {
                    try {
                        const response = await gapi.client.drive.files.get({ fileId: fileId, fields: 'id, name, parents, trashed' });
                        if (response.result && response.result.parents && response.result.parents.includes(appFolderId) && !response.result.trashed) {
                            GOOGLE_DRIVE_JSON_FILE_ID = fileId;
                            await loadBooksFromDrive(fileId);
                            return;
                        } else {
                            localStorage.removeItem('google_drive_json_file_id');
                        }
                    } catch (error) {
                        localStorage.removeItem('google_drive_json_file_id');
                    }
                }
                const response = await gapi.client.drive.files.list({ q: `'${appFolderId}' in parents and name = '${JSON_FILE_NAME}' and trashed = false`, fields: 'files(id)' });
                if (response.result.files && response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                } else {
                    const metadata = { name: JSON_FILE_NAME, mimeType: 'application/json', parents: [appFolderId] };
                    const formData = new FormData();
                    formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append("file", new Blob([DEFAULT_JSON_CONTENT], { type: 'application/json' }));
                    const token = gapi.client.getToken().access_token;
                    const uploadResponse = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                        method: 'POST',
                        headers: new Headers({ "Authorization": "Bearer " + token }),
                        body: formData
                    });
                    const result = await uploadResponse.json();
                    fileId = result.id;
                }
                localStorage.setItem('google_drive_json_file_id', fileId);
                GOOGLE_DRIVE_JSON_FILE_ID = fileId;
                await loadBooksFromDrive(fileId);
            } catch (error) {
                appContainer.innerHTML = `<div id="loading-message" style="color: red;">Error setting up Google Drive files. Please check console.</div>`;
            }
        }
        
        async function loadBooksFromDrive(fileId) {
            if (!fileId) return;
            try {
                loadingMessage.innerHTML = 'Loading content from Google Drive...';
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                books = JSON.parse(response.body);
                render(books);
                loadingMessage.style.display = 'none';
            } catch (error) {
                appContainer.innerHTML = '<div id="loading-message" style="color: red;">Error loading content.</div>';
            }
        }
        
        async function saveBooksToDrive() {
            if (!GOOGLE_DRIVE_JSON_FILE_ID) return;
            try {
                loadingMessage.style.display = 'block';
                loadingMessage.textContent = 'Saving...';
                const jsonContent = JSON.stringify(books, null, 2);
                const token = gapi.client.getToken().access_token;
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${GOOGLE_DRIVE_JSON_FILE_ID}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                    body: jsonContent
                });
                loadingMessage.style.display = 'none';
                render(books);
            } catch (error) {
                loadingMessage.textContent = 'Error saving!';
            }
        }
        
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function openBookModal(mode, bookId = null) {
            const bookForm = document.getElementById('bookForm');
            bookForm.reset();
            document.getElementById('bookId').value = '';
            if (mode === 'edit') {
                const bookToEdit = books.find(b => b.id === bookId);
                if (bookToEdit) {
                    Object.keys(bookToEdit).forEach(key => {
                        const el = document.getElementById(`book${key.charAt(0).toUpperCase() + key.slice(1)}`);
                        if(key === 'id') document.getElementById('bookId').value = bookToEdit.id;
                        else if (el) el.value = bookToEdit[key] || '';
                    });
                     // Manual mapping for different prop names
                    document.getElementById('bookRefLinkA').value = bookToEdit.reflinka || '';
                    document.getElementById('bookRefLinkB').value = bookToEdit.reflinkb || '';
                    document.getElementById('bookRefLinkC').value = bookToEdit.reflinkc || '';
                }
            }
            addOrEditBookModal.show();
        }
        
        async function submitBookForm(event) {
            event.preventDefault();
            const bookId = document.getElementById('bookId').value;
            const newBookData = {
                title: document.getElementById('bookTitle').value.trim(),
                description: document.getElementById('bookDescription').value.trim(),
                link: document.getElementById('bookLink').value.trim(),
                reflinka: document.getElementById('bookRefLinkA').value.trim(),
                reflinkb: document.getElementById('bookRefLinkB').value.trim(),
                reflinkc: document.getElementById('bookRefLinkC').value.trim(),
            };
            if (bookId) {
                const index = books.findIndex(b => b.id === bookId);
                if (index !== -1) books[index] = { ...books[index], ...newBookData };
            } else {
                newBookData.id = generateUniqueId();
                books.push(newBookData);
            }
            await saveBooksToDrive();
            addOrEditBookModal.hide();
        }
        
        async function deleteBook(bookId) {
            if (confirm("Are you sure?")) {
                books = books.filter(b => b.id !== bookId);
                await saveBooksToDrive();
            }
        }
        
        const render = (data) => {
            const app = document.getElementById('app');
            if (!data || data.length === 0) {
                app.innerHTML = `<div id="loading-message">${document.querySelector('input[name="search"]').value ? 'No matches found.' : 'No bookmarks yet.'}</div>`;
                return;
            }
            app.innerHTML = data.map(book => `
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">${book.title || 'No Title'}</h5>
                        <div class="card-actions">
                            <button class="btn btn-sm" onclick="openBookModal('edit', '${book.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm" onclick="deleteBook('${book.id}')" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="card-body p-0">
                        ${book.description ? `<p class="card-text mb-3 small">${book.description}</p>` : ''}
                        <div class="links-section d-flex flex-wrap gap-2">
                             ${book.link ? `<a href="${book.link}" target="_blank" class="btn btn-sm btn-primary">Answer Link</a>` : ''}
                            ${book.reflinka ? `<a href="${book.reflinka}" target="_blank" class="btn btn-sm">Ref 1</a>` : ''}
                            ${book.reflinkb ? `<a href="${book.reflinkb}" target="_blank" class="btn btn-sm">Ref 2</a>` : ''}
                            ${book.reflinkc ? `<a href="${book.reflinkc}" target="_blank" class="btn btn-sm">Ref 3</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        document.getElementById('search-books').addEventListener('submit', function (event) {
            event.preventDefault();
            const searchTerm = event.target.elements['search'].value.toLowerCase().trim();
            const tokens = searchTerm.split(' ').filter(Boolean);
            if (tokens.length) {
                const filtered = books.filter(book => {
                    const textToSearch = ((book.title || '') + ' ' + (book.description || '')).toLowerCase();
                    return tokens.every(token => textToSearch.includes(token));
                });
                render(filtered);
            } else {
                render(books);
            }
        });
        
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
