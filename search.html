<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="12.png" type="image/icon type">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pradeep Simba</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- Global & Base Colors (for shadows and general theme properties) --- */
            /* Light Theme */
            --general-bg-light: #f0f4f8; /* Base background for neumorphism calculations */
            --general-text-light: #000000; /* Base text color for neumorphism calculations */
            --primary-accent-light: #000000; /* Primary accent color for light theme */
            --shadow-light-1: #a3b1c6; /* Darker shadow for neumorphism */
            --shadow-light-2: #ffffff; /* Lighter shadow for neumorphism */
            --neumorphic-shadow-light: 6px 6px 12px var(--shadow-light-1), -6px -6px 12px var(--shadow-light-2);
            --neumorphic-shadow-inset-light: inset 4px 4px 8px var(--shadow-light-1), inset -4px -4px 8px var(--shadow-light-2);
            --general-border-light: #d1d9e6; /* General border color for light theme */

            /* Dark Theme */
            --general-bg-dark: #121212; /* Base background for neumorphism dark */
            --general-text-dark: #e0e0e0; /* Base text color for neumorphism calculations dark */
            --primary-accent-dark: #007bff; /* Primary accent color for dark theme */
            --shadow-dark-1: #0f0f0f; /* Darker shadow for neumorphism in dark mode */
            --shadow-dark-2: #2b2b2b; /* Lighter shadow for neumorphism in dark mode */
            --neumorphic-shadow-dark: 6px 6px 12px var(--shadow-dark-1), -6px -6px 12px var(--shadow-dark-2);
            --neumorphic-shadow-inset-dark: inset 4px 4px 8px var(--shadow-dark-1), inset -4px -4px 8px var(--shadow-dark-2);
            --general-border-dark: #3a3a3a; /* General border color for dark theme */

            /* Current active primary accent color (controlled by JS) */
            --primary: var(--primary-accent-light);

            /* --- Body Specific Colors --- */
            --body-bg-light: #f0f4f8; /* Very light blue-grey */
            --body-text-light: #34495e; /* Dark blue-grey */
            --body-bg-dark: #121212; /* Deep dark grey */
            --body-text-dark: #e0e0e0; /* Light grey */

            /* --- Navbar Specific Colors --- */
            --navbar-bg-light: #e8eff5; /* Slightly darker than body bg light */
            --navbar-brand-text-light: #000000; /* Darker green */
            --navbar-toggler-icon-light: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(0, 0, 0, 0.55)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
            --navbar-bg-dark: #1c1c1c; /* Slightly lighter than body bg dark */
            --navbar-brand-text-dark: #ffffff; /* Primary blue dark */
            --navbar-toggler-icon-dark: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255, 255, 255, 0.8)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");

            /* --- Input Field Specific Colors (General Form Controls like in Modal) --- */
            --input-general-bg-light: #ffffff; /* Pure white for clear input fields */
            --input-general-text-light: #212529; /* Very dark grey for input text */
            --input-general-placeholder-light: #6c757d; /* Standard muted grey */
            --input-label-text-light: #495057; /* Form label text color */
            --input-general-bg-dark: #2a2a2a; /* Dark grey for inputs */
            --input-general-text-dark: #f8f9fa; /* Very light grey */
            --input-general-placeholder-dark: #ced4da; /* Muted light grey */
            --input-label-text-dark: #e9ecef; /* Form label text color in dark mode */

            /* --- Search Bar Specific Colors (Overrides general input) --- */
            --search-input-bg-light: #e0e5ec; /* Classic neumorphic base for search */
            --search-input-text-light: #343a40; /* Darker text for search */
            --search-input-placeholder-light: #868e96; /* Muted grey for search placeholder */
            --search-input-bg-dark: #2c2c2c; /* Classic neumorphic base for search dark */
            --search-input-text-dark: #e9ecef; /* Light text for search */
            --search-input-placeholder-dark: #adb5bd; /* Muted light grey for search placeholder */

            /* --- Button Specific Colors --- */
            --button-default-bg-light: #e0e5ec; /* Default button background (matches general neumorphic base) */
            --button-default-text-light: #34495e; /* Dark text */
            --button-primary-bg-light: #a74128; /* Vibrant green */
            --button-primary-text-light: #ffffff; /* White */
            --button-secondary-bg-light: #6c757d; /* Muted grey-blue */
            --button-secondary-text-light: #ffffff; /* White */
            --button-default-bg-dark: #1a1a1a; /* Default button background dark (matches general neumorphic base) */
            --button-default-text-dark: #f0f0f0; /* Light text */
            --button-primary-bg-dark: #007bff; /* Vibrant blue */
            --button-primary-text-dark: #ffffff; /* White */
            --button-secondary-bg-dark: #722ad1; /* Darker muted grey */
            --button-secondary-text-dark: #ffffff; /* White */

            /* --- Card Specific Colors --- */
            --card-bg-light: #f8fafd; /* Even lighter, almost white for cards */
            --card-title-text-light: #000000; /* Vibrant green */
            --card-body-text-light: #495057; /* Darker grey */
            --card-hr-border-light: #ced4da; /* Light border */
            --card-action-btn-text-light: #555555; /* Dark grey */
            --card-action-btn-hover-text-light: #000000; /* Vibrant green */
            --card-bg-dark: #181818; /* Even darker for cards */
            --card-title-text-dark: #ffffff; /* Vibrant blue */
            --card-body-text-dark: #ced4da; /* Light grey */
            --card-hr-border-dark: #495057; /* Dark border */
            --card-action-btn-text-dark: #bbbbbb; /* Light grey */
            --card-action-btn-hover-text-dark: #ffffff; /* Vibrant blue */

            /* --- Modal Specific Colors --- */
            --modal-bg-light: #ffffff; /* Pure white for modals */
            --modal-header-border-light: #dee2e6; /* Light border */
            --modal-footer-border-light: #dee2e6; /* Light border */
            --modal-title-text-light: #343a40; /* Dark text */
            --modal-body-text-light: #495057; /* For paragraph text in modal body */
            --modal-close-btn-filter-light: none;
            --modal-bg-dark: #212121; /* Darker for modals */
            --modal-header-border-dark: #495057; /* Dark border */
            --modal-footer-border-dark: #495057; /* Dark border */
            --modal-title-text-dark: #f8f9fa; /* Light text */
            --modal-body-text-dark: #e0e0e0; /* For paragraph text in modal body */
            --modal-close-btn-filter-dark: invert(1) grayscale(100%) brightness(200%);

            /* --- Utility & Other Colors --- */
            --dark-mode-toggle-icon-light: #000000; /* Amber for sun icon */
            --loading-message-text-light: #6c757d; /* Muted grey */
            --dark-mode-toggle-icon-dark: #ffeb3b; /* Yellow for moon icon */
            --loading-message-text-dark: #adb5bd; /* Muted light grey */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg-light);
            color: var(--body-text-light);
            padding-top: 100px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-mode {
            background-color: var(--body-bg-dark);
            color: var(--body-text-dark);
        }

        /* --- Components --- */
        .navbar {
            border-radius: 20px;
            background-color: var(--navbar-bg-light);
            box-shadow: var(--neumorphic-shadow-light);
            border: none;
            padding: 0.8rem 1.5rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .dark-mode .navbar {
            background-color: var(--navbar-bg-dark);
            box-shadow: var(--neumorphic-shadow-dark);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.6rem;
            color: var(--navbar-brand-text-light) !important;
        }
        
        .dark-mode .navbar-brand {
            color: var(--navbar-brand-text-dark) !important;
        }

        .navbar-toggler {
            border: none;
        }
        .navbar-toggler:focus {
            box-shadow: none;
        }
        .navbar-toggler-icon {
            background-image: var(--navbar-toggler-icon-light);
        }
        .dark-mode .navbar-toggler-icon {
            background-image: var(--navbar-toggler-icon-dark);
        }


        /* --- General Form Controls (e.g., in Modal) --- */
        .form-control {
            border-radius: 30px;
            border: none;
            background-color: var(--input-general-bg-light);
            box-shadow: var(--neumorphic-shadow-inset-light);
            transition: box-shadow 0.2s ease, background-color 0.3s ease;
            padding: 0.5rem 1rem;
            color: var(--input-general-text-light);
        }
        .dark-mode .form-control {
            background-color: var(--input-general-bg-dark);
            box-shadow: var(--neumorphic-shadow-inset-dark);
            color: var(--input-general-text-dark);
        }
        .form-control::placeholder {
            color: var(--input-general-placeholder-light);
            opacity: 0.7;
        }
        .dark-mode .form-control::placeholder {
            color: var(--input-general-placeholder-dark);
        }
        .form-label {
            color: var(--input-label-text-light);
        }
        .dark-mode .form-label {
            color: var(--input-label-text-dark);
        }


        /* --- Search Bar Specific Overrides --- */
        #search-form .form-control {
            width: 220px;
            transition: width 0.3s ease-in-out;
            background-color: var(--search-input-bg-light);
            color: var(--search-input-text-light);
        }
        #search-form .form-control:focus {
            width: 300px;
        }
        @media (max-width: 991.98px) {
            #search-form .form-control, #search-form .form-control:focus {
                width: 100%;
            }
        }
        .dark-mode #search-form .form-control {
            background-color: var(--search-input-bg-dark);
            box-shadow: var(--neumorphic-shadow-inset-dark);
            color: var(--search-input-text-dark);
        }
        #search-form .form-control::placeholder {
            color: var(--search-input-placeholder-light);
        }
        .dark-mode #search-form .form-control::placeholder {
            color: var(--search-input-placeholder-dark);
        }


        /* --- Base Button Styles --- */
        .btn {
            border-radius: 30px;
            border: none;
            box-shadow: var(--neumorphic-shadow-light);
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            padding: 0.5rem 1rem;
        }
        .btn:active, .btn.active {
            box-shadow: var(--neumorphic-shadow-inset-light) !important;
            transform: translateY(1px);
        }
        .dark-mode .btn {
            box-shadow: var(--neumorphic-shadow-dark);
        }
        .dark-mode .btn:active, .dark-mode .btn.active {
            box-shadow: var(--neumorphic-shadow-inset-dark) !important;
        }

        /* --- Default Button (if no specific type is applied) --- */
        .btn:not(.btn-primary):not(.btn-secondary) {
            background-color: var(--button-default-bg-light);
            color: var(--button-default-text-light);
        }
        .dark-mode .btn:not(.btn-primary):not(.btn-secondary) {
            background-color: var(--button-default-bg-dark);
            color: var(--button-default-text-dark);
        }

        /* --- Primary Button --- */
        .btn-primary {
            background-color: var(--button-primary-bg-light);
            color: var(--button-primary-text-light);
        }
        .dark-mode .btn-primary {
            background-color: var(--button-primary-bg-dark);
            color: var(--button-primary-text-dark);
        }
        
        /* --- Secondary Button --- */
        .btn-secondary {
            background-color: var(--button-secondary-bg-light);
            color: var(--button-secondary-text-light);
        }
        .dark-mode .btn-secondary {
            background-color: var(--button-secondary-bg-dark);
            color: var(--button-secondary-text-dark);
        }

        /* --- Card Specifics --- */
        #app {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
        }
        .card {
            border-radius: 20px;
            background-color: var(--card-bg-light);
            box-shadow: var(--neumorphic-shadow-light);
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .card:hover {
            transform: translateY(-6px);
        }
        .dark-mode .card {
            background-color: var(--card-bg-dark);
            box-shadow: var(--neumorphic-shadow-dark);
        }
        .card-title {
            font-weight: 700;
            color: var(--card-title-text-light);
        }
        .dark-mode .card-title {
            color: var(--card-title-text-dark);
        }
        .card-text {
            color: var(--card-body-text-light);
            opacity: 0.9;
            font-size: 0.9rem;
        }
        .dark-mode .card-text {
            color: var(--card-body-text-dark);
        }
        .card hr {
            border-color: var(--card-hr-border-light);
            opacity: 0.5;
        }
        .dark-mode .card hr {
            border-color: var(--card-hr-border-dark);
        }
        .card-actions .btn {
            background-color: transparent;
            box-shadow: none;
            color: var(--card-action-btn-text-light);
            opacity: 0.6;
        }
        .dark-mode .card-actions .btn {
            color: var(--card-action-btn-text-dark);
        }
        .card-actions .btn:hover {
            opacity: 1;
            color: var(--card-action-btn-hover-text-light);
        }
        .dark-mode .card-actions .btn:hover {
            color: var(--card-action-btn-hover-text-dark);
        }
        
        /* --- Utilities & Other --- */
        #dark-mode-toggle {
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--dark-mode-toggle-icon-light);
            transition: transform 0.2s ease, color 0.3s ease;
        }
        #dark-mode-toggle:hover {
            transform: scale(1.15) rotate(-15deg);
        }
        .dark-mode #dark-mode-toggle {
            color: var(--dark-mode-toggle-icon-dark);
        }
        #loading-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            grid-column: 1 / -1;
            color: var(--loading-message-text-light);
        }
        .dark-mode #loading-message {
            color: var(--loading-message-text-dark);
        }

        .modal-content {
            border-radius: 20px;
            background-color: var(--modal-bg-light);
            box-shadow: var(--neumorphic-shadow-light);
            border: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-header, .modal-footer {
            border-color: var(--modal-header-border-light);
        }
        .dark-mode .modal-header, .dark-mode .modal-footer {
            border-color: var(--modal-header-border-dark);
        }
        .modal-title {
            color: var(--modal-title-text-light);
        }
        .dark-mode .modal-title {
            color: var(--modal-title-text-dark);
        }
        .modal-body p { /* Specific for paragraph in custom confirm modal */
            color: var(--modal-body-text-light);
        }
        .dark-mode .modal-body p {
            color: var(--modal-body-text-dark);
        }
        .btn-close {
            filter: var(--modal-close-btn-filter-light);
        }
        .dark-mode .btn-close {
            filter: var(--modal-close-btn-filter-dark);
        }
        
    </style>


</head>

<body onload="loadTheme()">

    <nav class="navbar navbar-expand-lg fixed-top mx-3 mt-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Pradeep Simba</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="navbar-nav ms-auto d-flex flex-lg-row flex-column align-items-lg-center gap-3 mt-3 mt-lg-0">
                    <form class="d-flex" id="search-form" role="search">
                        <input class="form-control" type="search" placeholder="Search..." name="search" aria-label="Search">
                    </form>
                    <div id="dark-mode-toggle" onclick="toggleTheme()">
                        <i id="theme-icon" class="fas fa-moon"></i>
                    </div>
                    <div class="auth-buttons d-flex gap-2">
                        <button class="btn btn-primary add-book-btn" style="display: none;" onclick="openBookModal('add')">Add Book</button>
                        <button class="btn btn-primary signin-btn">Sign In</button>
                        <button class="btn signout-btn" style="display: none;">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div id="app">
            <!-- Bookmarks will be rendered here by JavaScript -->
            <div id="loading-message">
                Please sign in to load content from Google Drive.
            </div>
        </div>
    </div>

    <div class="modal fade" id="addOrEditBookModal" tabindex="-1" aria-labelledby="addOrEditBookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-2">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="addOrEditBookModalLabel">Add New Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm">
                        <input type="hidden" id="bookId">
                        <!-- Form fields are unchanged -->
                        <div class="mb-3">
                            <label for="bookTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="bookDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="bookLink" class="form-label">Answer Link</label>
                            <input type="url" class="form-control" id="bookLink" placeholder="https://example.com/answer">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkA" class="form-label">Ref Link 1</label>
                            <input type="url" class="form-control" id="bookRefLinkA" placeholder="https://example.com/ref1">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkB" class="form-label">Ref Link 2</label>
                            <input type="url" class="form-control" id="bookRefLinkB" placeholder="https://example.com/ref2">
                        </div>
                        <div class="mb-3">
                            <label for="bookRefLinkC" class="form-label">Ref Link 3</label>
                            <input type="url" class="form-control" id="bookRefLinkC" placeholder="https://example.com/ref3">
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary py-2">Save Book</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- THEME TOGGLE FUNCTIONS ---
        function toggleTheme() {
            const element = document.body;
            const icon = document.getElementById("theme-icon");
            const isDarkMode = element.classList.contains("dark-mode");
            const theme = isDarkMode ? "light" : "dark";

            element.classList.toggle("dark-mode");
            localStorage.setItem("theme", theme);
            icon.className = theme === "dark" ? "fas fa-sun" : "fas fa-moon";

            const root = document.documentElement;
            // Update the primary accent color based on the theme
            if (theme === "dark") {
                root.style.setProperty("--primary", "var(--primary-accent-dark)");
            } else {
                root.style.setProperty("--primary", "var(--primary-accent-light)");
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem("theme") || "light";
            if (theme === "dark") {
                document.body.classList.add("dark-mode");
                document.getElementById("theme-icon").className = "fas fa-sun";
                document.documentElement.style.setProperty("--primary", "var(--primary-accent-dark)");
            } else {
                document.documentElement.style.setProperty("--primary", "var(--primary-accent-light)");
            }
        }

        // --- GOOGLE DRIVE API AND ALL OTHER JS LOGIC (UNCHANGED) ---

        // IMPORTANT: REPLACE THESE WITH YOUR ACTUAL GOOGLE CLOUD PROJECT CREDENTIALS
        const CLIENT_ID = '683702979714-b9p8hkaqrrk2g12nbv3jqkbsf5mlmi59.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyBF-k8OwJlDftANtaR8kiX5KIRym4Zlvp8'; 
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        let GOOGLE_DRIVE_JSON_FILE_ID = '';
        const APP_FOLDER_NAME = "Pradeep Simba App Data";
        const JSON_FILE_NAME = "data.json";
        const DEFAULT_JSON_CONTENT = '[]';
        let tokenClient;
        let signinButton, signoutButton, addBookButton, appContainer, loadingMessage;
        let addOrEditBookModal;
        let gapiInited = false;
        let gisInited = false;
        let domLoaded = false;
        let books = [];
        let searchForm;
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                checkIfAllReady();
            } catch (error) { console.error("Error initializing GAPI client:", error); }
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse,
            });
            gisInited = true;
            checkIfAllReady();
        }
        
        function checkIfAllReady() {
            if (gapiInited && gisInited && domLoaded) {
                signinButton.style.display = 'block';
                if (gapi.client.getToken()) { handleAuthSuccess(); }
            }
        }
        
        window.onload = () => {
            signinButton = document.querySelector('.signin-btn');
            signoutButton = document.querySelector('.signout-btn');
            addBookButton = document.querySelector('.add-book-btn');
            appContainer = document.getElementById('app');
            loadingMessage = document.getElementById('loading-message');
            addOrEditBookModal = new bootstrap.Modal(document.getElementById('addOrEditBookModal'));
            searchForm = document.getElementById('search-form');

            if (signinButton) signinButton.onclick = handleAuthClick;
            if (signoutButton) signoutButton.onclick = handleSignoutClick;
            if (addBookButton) addBookButton.onclick = () => openBookModal('add'); // Ensure this is correctly bound
            document.getElementById('bookForm').addEventListener('submit', submitBookForm);
            searchForm.addEventListener('submit', handleSearch);
            searchForm.elements['search'].addEventListener('input', handleSearch); // Search as you type
            
            domLoaded = true;
            loadTheme();
            checkIfAllReady();
        };
        
        async function handleTokenResponse(resp) {
            if (resp.error) return;
            gapi.client.setToken(resp);
            handleAuthSuccess();
        }
        
        function handleAuthClick() {
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    signinButton.style.display = 'block';
                    signoutButton.style.display = 'none';
                    addBookButton.style.display = 'none';
                    appContainer.innerHTML = '<div id="loading-message">Please sign in to load content from Google Drive.</div>';
                    books = [];
                });
            }
        }
        
        async function handleAuthSuccess() {
            signinButton.style.display = 'none';
            signoutButton.style.display = 'block';
            addBookButton.style.display = 'block';
            loadingMessage.innerHTML = 'Checking/Creating Google Drive files...';
            await checkAndCreateJsonFile();
        }
        
        async function checkAndCreateAppDataFolder() {
            let folderId = localStorage.getItem('app_folder_id');
            if (folderId) {
                try {
                    const response = await gapi.client.drive.files.get({ fileId: folderId, fields: 'id, name, mimeType, trashed' });
                    if (response.result && response.result.mimeType === 'application/vnd.google-apps.folder' && !response.result.trashed) return folderId;
                    else localStorage.removeItem('app_folder_id');
                } catch (error) { localStorage.removeItem('app_folder_id'); }
            }
            const response = await gapi.client.drive.files.list({ q: `name = '${APP_FOLDER_NAME}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`, fields: 'files(id)' });
            if (response.result.files && response.result.files.length > 0) {
                folderId = response.result.files[0].id;
            } else {
                const folderResponse = await gapi.client.drive.files.create({ resource: { name: APP_FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' }, fields: 'id' });
                folderId = folderResponse.result.id;
            }
            localStorage.setItem('app_folder_id', folderId);
            return folderId;
        }
        
        async function checkAndCreateJsonFile() {
            try {
                const appFolderId = await checkAndCreateAppDataFolder();
                let fileId = localStorage.getItem('google_drive_json_file_id');
                if (fileId) {
                    try {
                        const response = await gapi.client.drive.files.get({ fileId: fileId, fields: 'id, name, parents, trashed' });
                        if (response.result && response.result.parents && response.result.parents.includes(appFolderId) && !response.result.trashed) {
                            GOOGLE_DRIVE_JSON_FILE_ID = fileId;
                            await loadBooksFromDrive(fileId);
                            return;
                        } else { localStorage.removeItem('google_drive_json_file_id'); }
                    } catch (error) { localStorage.removeItem('google_drive_json_file_id'); }
                }
                const response = await gapi.client.drive.files.list({ q: `'${appFolderId}' in parents and name = '${JSON_FILE_NAME}' and trashed = false`, fields: 'files(id)' });
                if (response.result.files && response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                } else {
                    const metadata = { name: JSON_FILE_NAME, mimeType: 'application/json', parents: [appFolderId] };
                    const formData = new FormData();
                    formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    formData.append("file", new Blob([DEFAULT_JSON_CONTENT], { type: 'application/json' }));
                    const token = gapi.client.getToken().access_token;
                    const uploadResponse = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", { method: 'POST', headers: new Headers({ "Authorization": "Bearer " + token }), body: formData });
                    const result = await uploadResponse.json();
                    fileId = result.id;
                }
                localStorage.setItem('google_drive_json_file_id', fileId);
                GOOGLE_DRIVE_JSON_FILE_ID = fileId;
                await loadBooksFromDrive(fileId);
            } catch (error) { appContainer.innerHTML = `<div id="loading-message" style="color: red;">Error setting up Google Drive files. Please check console.</div>`; }
        }
        
        async function loadBooksFromDrive(fileId) {
            if (!fileId) return;
            try {
                loadingMessage.innerHTML = 'Loading content from Google Drive...';
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                books = JSON.parse(response.body);
                render(books);
                loadingMessage.style.display = 'none';
            } catch (error) { appContainer.innerHTML = '<div id="loading-message" style="color: red;">Error loading content.</div>'; }
        }
        
        async function saveBooksToDrive() {
            if (!GOOGLE_DRIVE_JSON_FILE_ID) return;
            try {
                loadingMessage.style.display = 'block';
                loadingMessage.textContent = 'Saving...';
                const jsonContent = JSON.stringify(books, null, 2);
                const token = gapi.client.getToken().access_token;
                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${GOOGLE_DRIVE_JSON_FILE_ID}?uploadType=media`, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, body: jsonContent });
                loadingMessage.style.display = 'none';
                render(books);
            } catch (error) { loadingMessage.textContent = 'Error saving!'; }
        }
        
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function openBookModal(mode, bookId = null) {
            const bookForm = document.getElementById('bookForm');
            bookForm.reset();
            document.getElementById('bookId').value = '';
            if (mode === 'edit') {
                const bookToEdit = books.find(b => b.id === bookId);
                if (bookToEdit) {
                    document.getElementById('bookId').value = bookToEdit.id;
                    document.getElementById('bookTitle').value = bookToEdit.title || '';
                    document.getElementById('bookDescription').value = bookToEdit.description || '';
                    document.getElementById('bookLink').value = bookToEdit.link || '';
                    document.getElementById('bookRefLinkA').value = bookToEdit.reflinka || '';
                    document.getElementById('bookRefLinkB').value = bookToEdit.reflinkb || '';
                    document.getElementById('bookRefLinkC').value = bookToEdit.reflinkc || '';
                }
            }
            addOrEditBookModal.show();
        }
        
        async function submitBookForm(event) {
            event.preventDefault();
            const bookId = document.getElementById('bookId').value;
            const newBookData = {
                title: document.getElementById('bookTitle').value.trim(),
                description: document.getElementById('bookDescription').value.trim(),
                link: document.getElementById('bookLink').value.trim(),
                reflinka: document.getElementById('bookRefLinkA').value.trim(),
                reflinkb: document.getElementById('bookRefLinkB').value.trim(),
                reflinkc: document.getElementById('bookRefLinkC').value.trim(),
            };
            if (bookId) {
                const index = books.findIndex(b => b.id === bookId);
                if (index !== -1) books[index] = { ...books[index], ...newBookData };
            } else {
                newBookData.id = generateUniqueId();
                books.push(newBookData);
            }
            await saveBooksToDrive();
            addOrEditBookModal.hide();
        }
        
        async function deleteBook(bookId) {
            // Replaced alert/confirm with a custom modal for better UX and consistency
            showCustomConfirm('Are you sure you want to delete this bookmark?', async () => {
                books = books.filter(b => b.id !== bookId);
                await saveBooksToDrive();
            });
        }

        // Custom Confirm Modal (replaces browser's confirm)
        function showCustomConfirm(message, onConfirm) {
            const modalHtml = `
                <div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content p-2">
                            <div class="modal-header border-0">
                                <h5 class="modal-title" id="customConfirmModalLabel">Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>${message}</p>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirmActionButton">Confirm</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // Remove any existing modal to prevent duplicates
            const existingModal = document.getElementById('customConfirmModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const customConfirmModal = new bootstrap.Modal(document.getElementById('customConfirmModal'));
            customConfirmModal.show();

            document.getElementById('confirmActionButton').onclick = () => {
                onConfirm();
                customConfirmModal.hide();
            };
        }

        const render = (data) => {
            const app = document.getElementById('app');
            const searchTerm = searchForm.elements['search'].value;
            if (!data || data.length === 0) {
                app.innerHTML = `<div id="loading-message">${searchTerm ? 'No bookmarks match your search.' : 'No bookmarks yet. Click "Add Book" to start!'}</div>`;
                return;
            }
            app.innerHTML = data.map(book => `
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">${book.title || 'No Title'}</h5>
                        <div class="card-actions">
                            <button class="btn btn-sm" onclick="openBookModal('edit', '${book.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm" onclick="deleteBook('${book.id}')" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="card-body p-0">
                        ${book.description ? `<p class="card-text mb-3">${book.description}</p>` : ''}
                        <div class="links-section d-flex flex-wrap gap-2">
                             ${book.link ? `<a href="${book.link}" target="_blank" class="btn btn-sm btn-primary">Answer Link</a>` : ''}
                            ${book.reflinka ? `<a href="${book.reflinka}" target="_blank" class="btn btn-sm btn-secondary">Ref 1</a>` : ''}
                            ${book.reflinkb ? `<a href="${book.reflinkb}" target="_blank" class="btn btn-sm btn-secondary">Ref 2</a>` : ''}
                            ${book.reflinkc ? `<a href="${book.reflinkc}" target="_blank" class="btn btn-sm btn-secondary">Ref 3</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function handleSearch(event) {
            event.preventDefault();
            const searchTerm = event.target.value.toLowerCase().trim();
            const tokens = searchTerm.split(' ').filter(Boolean);
            if (tokens.length) {
                const filtered = books.filter(book => {
                    const textToSearch = ((book.title || '') + ' ' + (book.description || '')).toLowerCase();
                    return tokens.every(token => textToSearch.includes(token));
                });
                render(filtered);
            } else {
                render(books);
            }
        }
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>

</html>
